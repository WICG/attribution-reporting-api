{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/WICG/attribution-reporting-api/source.schema.json",
  "title": "Source",
  "description": "An Attribution Reporting source registration",
  "type": "object",
  "properties": {
    "aggregatable_report_window": {
      "$ref": "#/$defs/legacy_duration"
    },
    "aggregation_keys": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/hex128"
      },
      "maxProperties": 20,
      "default": {}
    },
    "debug_key": {
      "$ref": "#/$defs/unsigned_base10_integer",
      "default": null
    },
    "debug_reporting": {
      "type": "boolean",
      "default": false
    },
    "destination": {
      "oneOf": [
        {
          "$ref": "#/$defs/destination"
        },
        {
          "type": "array",
          "items": {
            "$ref": "#/$defs/destination"
          },
          "minItems": 1,
          "maxItems": 3
        }
      ]
    },
    "event_report_window": {
      "$ref": "#/$defs/legacy_duration"
    },
    "event_report_windows": {
      "type": "object",
      "properties": {
        "start_time": {
          "$ref": "#/$defs/non_negative_integer",
          "default": 0
        },
        "end_times": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/positive_integer"
          },
          "maxItems": 5,
          "minItems": 1
        }
      },
      "required": ["end_times"]
    },
    "expiry": {
      "$ref": "#/$defs/legacy_duration"
    },
    "filter_data": {
      "type": "object",
      "propertyNames": {
        "not": {
          "const": "source_type"
        }
      },
      "additionalProperties": {
        "type": "array",
        "items": {
          "type": "string"
        },
        "maxItems": 50
      },
      "maxProperties": 50,
      "default": {}
    },
    "priority": {
      "$ref": "#/$defs/signed_base10_integer",
      "default": "0"
    },
    "source_event_id": {
      "$ref": "#/$defs/unsigned_base10_integer",
      "default": "0"
    },
    "max_event_level_reports": {
      "$ref": "#/$defs/non_negative_integer",
      "$comment": "Default depends on source type",
      "maximum": 20
    }
  },
  "required": ["destination"],

  "dependentSchemas": {
    "event_report_window": {
      "not": {
        "required": ["event_report_windows"]
      }
    }
  },

  "$defs": {
    "destination": {
      "type": "string",
      "$comment": "TODO: specify format"
    },
    "hex128": {
      "type": "string",
      "pattern": "^0[xX][0-9a-fA-F]{1,32}$"
    },
    "signed_base10_integer": {
      "type": "string",
      "pattern": "^-?[0-9]+$"
    },
    "unsigned_duration_in_seconds": {
      "$ref": "#/$defs/unsigned_base10_integer",
      "description": "Seconds",
      "default": "2592000"
    },
    "unsigned_base10_integer": {
      "type": "string",
      "pattern": "^[0-9]+$"
    },
    "non_negative_integer": {
      "type": "integer",
      "minimum": 0
    },
    "positive_integer": {
      "type": "integer",
      "exclusiveMinimum": 0
    },
    "legacy_duration": {
      "oneOf": [
        {"$ref": "#/$defs/non_negative_integer"},
        {"$ref": "#/$defs/unsigned_duration_in_seconds"}
      ]
    }
  }
}
